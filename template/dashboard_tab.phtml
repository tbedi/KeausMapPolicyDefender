<div class="row">
    <div class="cell" class="input"> 
       <div class="dashhead">Top Violations by Dealer</div>

        <table class="Dash" >
            <tr >
                <td >Dealer</td>	
                <td >curr Count</td>
                <td >Prev Count</td>
                <td >%</td>
                <td >Total violated</td>

            </tr>
<?php
include('db.php');

$sql1 = "SELECT
website.name name, crawl_results.website_id, count(crawl_results.website_id) countcurrent, tab1.countprev countprev, count(crawl_results.website_id)-tab1.countprev diff, count(crawl_results.website_id)+tab1.countprev countsum
from website
inner join
crawl_results
on website.id = crawl_results.website_id
inner join crawl
on crawl.id=crawl_results.crawl_id
and crawl_results.crawl_id = (select max(id) from crawl)
inner join
(
SELECT
website.name name,count(crawl_results.website_id) countprev
from website
inner join
crawl_results
on website.id = crawl_results.website_id
inner join crawl
on crawl.id=crawl_results.crawl_id
and crawl_results.crawl_id = (select max(id) from crawl where id != (select max(id) from crawl) )
group by website.name
) as tab1 on tab1.name = website.name where crawl_results.violation_amount>0.05 and website.excluded=0 
group by website.name
order by countcurrent desc limit 10
";
$result1 = mysql_query($sql1);


while ($row = mysql_fetch_array($result1)) {

    
    $avg = ($row['countcurrent']+$row['countprev'])/2;
    $percent = ($row['diff']/$avg)*100;
    echo "<tr>";
    echo "<td>";
    if($row['diff']<0) $x = "red";
    elseif ($row['diff']==0) $x = "black";
    elseif ($row['diff']>0) $x = "green";
    echo "<a href="."index.php?tab=violations-history&website_id=". $row['website_id'] ."&wname=".$row['name'].">" . $row['name'] . "</td>" . "<td>" . $row['countcurrent']."(" . "<font color="."$x".">".($row['diff'] > 0 ? "+" : ""). $row['diff']."</font> " . ")"."</td>" . "<td>" . $row['countprev'] . "</td>" . "<td>" . "<font color="."$x".">".($row['diff'] > 0 ? "+" : "").round($percent, 2)."%"."</font> ". "</td>" . "<td>" . $row['countsum'] . "</td>" . "</tr>";
    echo "</td>";
    echo "</tr>";
}
//print_r($chart_vendor_rows);
echo "</table>";


//print_r($js_data_string_vendors);
?>	
</div>
<!--</div>
<div class="row">-->
    <div class="cell" class="input">
       <div class="dashhead">Top violations by SKU</div>

        <table class="Dash">
            <tr>
                <td width="200">SKU</td>	

                <td >Curr Count</td>
                <td >Prev Count</td>
                <td >Total</td>
            </tr>
<?php
include('db.php');

$sql2 = "select
catalog_product_flat_1.sku, crawl_results.product_id, 
count(crawl_results.product_id) as currentcount, if(tab1.prevcount is null,0,tab1.prevcount) prevcount, count(crawl_results.product_id)-if(tab1.prevcount is null,0,tab1.prevcount) diff,
count(crawl_results.product_id)+if(tab1.prevcount is null,0,tab1.prevcount) countsum
from crawl_results inner join catalog_product_flat_1 on crawl_results.product_id = catalog_product_flat_1.entity_id
inner join crawl on crawl.id = crawl_results.crawl_id and crawl_results.crawl_id = (select max(id) from crawl) left join ( select
catalog_product_flat_1.sku sku1, count(crawl_results.product_id) as prevcount from crawl_results inner join catalog_product_flat_1 on crawl_results.product_id = catalog_product_flat_1.entity_id
inner join crawl on crawl.id = crawl_results.crawl_id and crawl_results.crawl_id = (select max(id) from crawl where id != (select max(id) from crawl))
group by crawl_results.product_id ) as tab1 on tab1.sku1 = catalog_product_flat_1.sku where crawl_results.violation_amount>0.05 group by crawl_results.product_id order by currentcount desc limit 10";
$result2 = mysql_query($sql2);


while ($row = mysql_fetch_array($result2)) {

    echo "<tr>";
    echo "<td>";
    if($row['diff']<0) $x = "red";
    elseif ($row['diff']==0) $x = "black";
    elseif ($row['diff']>0) $x = "green";
    echo "<a href="."index.php?tab=violations-history&product_id=". $row['product_id'] ."&sku=". $row['sku'] .">" . $row['sku'] . "</td>" . "<td>" . $row['currentcount']."(" . "<font color="."$x".">".($row['diff'] > 0 ? "+" : ""). $row['diff']."</font> " . ")"."</td>" . "<td>" . $row['prevcount'] . "</td>"."<td>" . $row['countsum'] . "</td>" . "</tr>";
}
echo "</table>";
?>

    </div>
</td>
<div class="cell" class="input">         
    <td ><div class="dashhead">Top Violations Vendor</div>

        <table class="Dash">
            <tr>

                <td width="200">SKU</td>
                <td width="200">Violation Amount</td>

            </tr>
<?php
include('db.php');

$sql3 = "SELECT
catalog_product_flat_1.sku,
crawl_results.violation_amount as violation_amount
from website
inner join
prices.crawl_results
on prices.website.id = prices.crawl_results.website_id
inner join catalog_product_flat_1
on catalog_product_flat_1.entity_id=crawl_results.product_id
inner join
crawl
on crawl.id=crawl_results.crawl_id
where crawl_results.violation_amount>0.05
and
website.excluded=0
AND crawl.id = (SELECT id FROM crawl ORDER BY id DESC LIMIT 1)
and
crawl.id =
(select max(crawl.id) from crawl) order by violation_amount desc
limit 10";
$result3 = mysql_query($sql3);

while ($row = mysql_fetch_array($result3)) {
    echo "<tr>";
    echo "<td>";
    echo "<a href=" . ">" . $row['sku'] . "</td>" . "<td>$" . $row['violation_amount'] . "</td>" . "</tr>";
}
echo "</table>";
?>
</div>
<?php
include('db.php');

$sql4 = "select
crawl.date_executed Date,
count(distinct crawl_results.product_id) as skucount,
count(distinct crawl_results.website_id) as dealercount
from
crawl_results
inner join
catalog_product_flat_1
on crawl_results.product_id = catalog_product_flat_1.entity_id
inner join
website
on crawl_results.website_id = website.id
inner join
crawl
on crawl.id = crawl_results.crawl_id
and date_format(crawl.date_executed, '%Y-%m-%d') between DATE_ADD(sysdate(), INTERVAL -7 DAY) and sysdate()
group by date_format(crawl.date_executed, '%Y-%m-%d') limit 10
";
$result4 = mysql_query($sql4);
$chart_vendor_rows = array();
$chart_violation_amount_rows = array();
$chart_violation_amount2_rows = array();
while ($row = mysql_fetch_array($result4)) {
    
    $chart_row = strtotime($row ['Date']) * 1000;
    array_push($chart_vendor_rows, $chart_row);
    array_push($chart_violation_amount_rows, $row['skucount']);
    array_push($chart_violation_amount2_rows, $row['dealercount']);
}

$js_data_string_vendors = implode($chart_vendor_rows, ",");
$js_data_string_amounts = implode($chart_violation_amount_rows, ",");
$js_data2_string_amounts = implode($chart_violation_amount2_rows, ",");
?>
<div id="container" style="min-width: 310px; height: 400px ; margin: 0 auto"></div>
    <script>$(function () {
        $('#container').highcharts({
            chart: {
                type: 'areaspline'
            },
            title: {
                text: 'Violations by Dealers & Products'
            },
//            legend: {
//                layout: 'vertical',
//                align: 'left',
//                verticalAlign: 'top',
//                x: 150,
//                y: 100,
//                floating: true,
//                borderWidth: 1,
//                backgroundColor: '#FFFFFF'
//            },
            xAxis: {
                categories: [
                    <?php echo $js_data_string_vendors; ?>
                ],
                labels: {
                    rotation: -90,
                    align: 'right',
                    style: {
                        fontSize: '13px',
                        fontFamily: 'Arial'
                    },
                    formatter: function() {
                        return Highcharts.dateFormat('%a %d %b', this.value);
                    },
                }

            },
            yAxis: {
                title: {
                    text: 'Violations',
                style: {
                        fontSize: '13px',
                        fontFamily: 'Arial',
                        fontWeight: 'regular'
                    },
                },
                labels: {
                    formatter: function() {
                    
                        return '' + Highcharts.numberFormat(this.value / 1, 0) ;                
    }
                },
            
            },
            tooltip: {
                formatter: function() {
                    return '<b>' + Highcharts.dateFormat('%a %d %b %Y', this.x) + '</b><br/>' +
                           'Price Violations: ' +  this.y;
                }
            },
            credits: {
                enabled: false
            },
//            plotOptions: {
//                areaspline: {
//                    fillOpacity: 0.5
//                }
//            },
            series: [{
                name: 'SKU Count',
                data: [<?php echo $js_data_string_amounts; ?>]
           }, {
                name: 'Dealer Count',
                data: [<?php echo $js_data2_string_amounts; ?>]
           }]
        });
    });
    </script>

</div>
